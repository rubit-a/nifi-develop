name: Deploy to EC2

on:
  push:
    branches:
      - master  # master 브랜치에 푸시될 때 자동 배포
  workflow_dispatch:  # 수동 배포도 가능하도록 설정

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: JDK 21 설정
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'maven'

    - name: Maven 빌드 (NAR 생성)
      run: |
        echo "========================================="
        echo " Building Custom NiFi NAR"
        echo "========================================="
        mvn clean package -DskipTests

        # 빌드된 NAR 파일 확인
        echo ""
        echo "Build artifacts:"
        ls -lh nifi-custom-nar/target/*.nar

    - name: EC2 배포 준비
      run: |
        # prod/nar 디렉토리에 NAR 파일 복사
        mkdir -p prod/nar
        cp nifi-custom-nar/target/nifi-custom-nar-1.0.0.nar prod/nar/
        echo "✓ NAR file prepared for deployment"

    - name: SSH 키 설정
      env:
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$EC2_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        # SSH 설정 파일 생성 (보안 및 연결 안정성 향상)
        cat >> ~/.ssh/config << EOF
        Host ec2-deploy
          HostName ${{ secrets.EC2_HOST }}
          User ${{ secrets.EC2_USER }}
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile /dev/null
          ConnectTimeout 30
          ServerAliveInterval 60
        EOF
        chmod 600 ~/.ssh/config

    - name: EC2 연결 테스트
      run: |
        echo "Testing SSH connection to EC2..."
        ssh ec2-deploy "echo 'SSH connection successful'"

    - name: 설치 스크립트를 EC2로 전송
      run: |
        # EC2에 디렉토리 생성
        ssh ec2-deploy "mkdir -p /tmp/nifi-install-scripts"

        # prod/script 디렉토리 전체를 EC2로 전송
        scp -r prod/script ec2-deploy:/tmp/nifi-install-scripts/
        echo "✓ Setup scripts uploaded to EC2"

    - name: NiFi 설치 확인 및 자동 설정
      run: |
        echo "========================================="
        echo " Checking NiFi Installation on EC2"
        echo "========================================="

        ssh ec2-deploy 'bash -s' << 'ENDSSH'
          set -e

          if [ ! -d "/opt/nifi" ]; then
            echo "⚠️  NiFi not found. Starting automatic installation..."
            echo ""

            cd /tmp/nifi-install-scripts/script
            chmod +x *.sh
            ./nifi-setup.sh

            echo ""
            echo "✅ NiFi has been installed and configured successfully!"
          else
            echo "✅ NiFi is already installed at /opt/nifi"
          fi

          echo ""
          echo "NiFi Status:"
          if systemctl is-active --quiet nifi; then
            echo "✅ NiFi is running"
          else
            echo "⚠️  NiFi is not running. Starting..."
            if ! sudo systemctl start nifi; then
              echo ""
              echo "❌ Failed to start NiFi. Checking logs..."
              echo ""
              echo "=== systemctl status ==="
              sudo systemctl status nifi --no-pager -l || true
              echo ""
              echo "=== NiFi bootstrap log (last 50 lines) ==="
              sudo tail -50 /opt/nifi/logs/nifi-bootstrap.log 2>/dev/null || echo "No bootstrap log found"
              echo ""
              echo "=== NiFi app log (last 50 lines) ==="
              sudo tail -50 /opt/nifi/logs/nifi-app.log 2>/dev/null || echo "No app log found"
              echo ""
              echo "⚠️  Continuing deployment despite NiFi start failure..."
              echo "   NiFi may need more time to start. Check logs after deployment."
            else
              echo "✅ NiFi started successfully"
            fi
          fi
        ENDSSH

    - name: EC2에 NAR 파일 배포
      env:
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        echo "========================================="
        echo " Deploying to EC2: ${{ secrets.EC2_HOST }}"
        echo "========================================="

        # NAR 파일을 EC2로 전송
        scp prod/nar/nifi-custom-nar-1.0.0.nar ec2-deploy:/tmp/
        echo "✓ NAR file uploaded to EC2"

        # EC2에서 배포 스크립트 실행
        ssh ec2-deploy bash << 'ENDSSH'
          set -e

          echo "[1/5] Updating systemd service file..."
          # systemd 서비스 파일 업데이트
          sudo tee /etc/systemd/system/nifi.service > /dev/null << 'SERVICE_EOF'
[Unit]
Description=Apache NiFi
After=network.target

[Service]
Type=forking
User=$(whoami)
Group=$(whoami)
ExecStart=/opt/nifi/bin/nifi.sh start
ExecStop=/opt/nifi/bin/nifi.sh stop
ExecRestart=/opt/nifi/bin/nifi.sh restart
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE_EOF

          sudo systemctl daemon-reload
          echo "✓ Service file updated"

          echo "[2/5] Stopping NiFi..."
          sudo systemctl stop nifi || true

          echo "[3/5] Backing up existing NAR..."
          NAR_DIR="/opt/nifi/lib"
          BACKUP_DIR="/opt/nifi/lib/backup-$(date +%Y%m%d-%H%M%S)"

          if [ -f "${NAR_DIR}/nifi-custom-nar-1.0.0.nar" ]; then
            sudo mkdir -p ${BACKUP_DIR}
            sudo mv ${NAR_DIR}/nifi-custom-nar-*.nar ${BACKUP_DIR}/ 2>/dev/null || true
            echo "✓ Previous NAR backed up to ${BACKUP_DIR}"
          fi

          echo "[3/4] Installing new NAR..."
          sudo mv /tmp/nifi-custom-nar-1.0.0.nar ${NAR_DIR}/
          sudo chown $(whoami):$(whoami) ${NAR_DIR}/nifi-custom-nar-1.0.0.nar
          echo "✓ New NAR installed"

          echo "[4/4] Starting NiFi..."
          if ! sudo systemctl start nifi; then
            echo ""
            echo "❌ Failed to start NiFi. Checking logs..."
            echo ""

            echo "=== Java version ==="
            java -version 2>&1

            echo ""
            echo "=== NiFi startup script check ==="
            ls -l /opt/nifi/bin/nifi.sh

            echo ""
            echo "=== systemctl status (full) ==="
            sudo systemctl status nifi --no-pager --full --lines=50 2>&1 || true

            echo ""
            echo "=== journalctl (last 100 lines) ==="
            sudo journalctl -u nifi --no-pager -n 100 2>&1 || true

            echo ""
            echo "=== NiFi bootstrap log ==="
            if [ -f /opt/nifi/logs/nifi-bootstrap.log ]; then
              tail -100 /opt/nifi/logs/nifi-bootstrap.log
            else
              echo "No bootstrap log found"
            fi

            echo ""
            echo "=== NiFi app log ==="
            if [ -f /opt/nifi/logs/nifi-app.log ]; then
              tail -100 /opt/nifi/logs/nifi-app.log
            else
              echo "No app log found"
            fi

            echo ""
            echo "=== Checking NiFi process ==="
            ps aux | grep nifi | grep -v grep || echo "No NiFi process found"

            exit 1
          fi

          echo ""
          echo "========================================="
          echo " Deployment completed successfully!"
          echo "========================================="
          echo ""
          echo "NiFi Status:"
          sudo systemctl status nifi --no-pager | head -n 10
        ENDSSH

        echo "✅ Deployment completed!"

    - name: SSH 키 정리
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa ~/.ssh/config
        echo "✓ SSH credentials cleaned up"

    - name: 배포 결과 알림
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ 배포 성공!"
          echo "EC2 Host: ${{ secrets.EC2_HOST }}"
          echo "NAR 파일: nifi-custom-nar-1.0.0.nar"
        else
          echo "❌ 배포 실패"
          echo "배포 중 오류가 발생했습니다. Actions 로그를 확인해주세요."
        fi